<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <link th:href="@{/css/bootstrap.min.css}"
          href="../css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <style>
        .container {
            max-width: 560px;
        }

        .field-error {
            border-color: #dc3545;
            color: #dc3545;
        }
    </style>
    <title th:text="#{label.change}">회원 수정</title>
</head>
<body>

<div class="container">
    <div class="py-5 text-center">
        <h2 th:text="#{label.change}">정보 수정</h2>
    </div>

    <h4 class="mb-3 text-center" th:text="#{label.infoChange}">수정 정보 입력</h4>

    <form action="" onsubmit="return validate();" th:action th:object="${form}" method="post">
        <div th:if="${#fields.hasGlobalErrors()}">
            <p class="field-error" th:each="err : ${#fields.globalErrors()}"
               th:text="${err}">전체 오류 메시지</p>
        </div>

        <div>
            <label for="id" th:text="#{label.member.id}">아이디는 변경할 수 없습니다.</label>
            <input type="text" id="id" disabled th:field="*{id}" class="form-control">
        </div>
        <div>
            <label for="password" th:text="#{label.member.password}">비밀번호</label>
            <input type="text" id="password" required th:field="*{password}"
                   class="form-control" minlength="4" maxlength="20"
                   th:errorclass="field-error">
            <small id="passwordHelp" th:text="#{label.member.passwordHelp}" class="form-text text-muted">
                문자와 숫자를 조합하여 4자 이상 20자 이하로 입력해주세요.
            </small>
            <div class="field-error" th:errors="*{password}"/>
        </div>
        <div>
            <label for="name" th:text="#{label.member.name}">이름</label>
            <input type="text" id="name" minlength="2" maxlength="20" required th:field="*{name}" class="form-control"
                   th:errorclass="field-error">
            <div class="field-error" th:errors="*{name}"/>
        </div>
        <div>
            <label for="age" th:text="#{label.member.age}">나이</label>
            <input type="number" id="age" min="12" max="120" th:field="*{age}" class="form-control"
                   th:errorclass="field-error">
            <div class="field-error" th:errors="*{age}"/>
        </div>
        <div>
            <label for="phone" th:text="#{label.member.phone}">전화번호</label>
            <input type="tel" id="phone" required th:field="*{phone}" class="form-control"
                   th:errorclass="field-error">
            <small id="phoneHelp" th:text="#{label.member.phoneHelp}" class="form-text text-muted">
                010으로 시작하는 전화번호만 입력 가능합니다.
            </small>
            <div class="field-error" th:errors="*{phone}"/>
        </div>
        <div>
            <label for="address" th:text="#{label.member.address}">주소</label>
            <input type="text" id="address" th:field="*{address}" class="form-control"
                   th:errorclass="field-error">
            <div class="field-error" th:errors="*{address}"/>
        </div>
        <div>
            <label for="email" th:text="#{label.member.email}">이메일</label>
            <input type="email" id="email" th:field="*{email}" class="form-control"
                   th:errorclass="field-error">
            <div class="field-error" th:errors="*{email}"/>
        </div>
        <div>
            <label for="license" th:text="#{label.member.licenseNumber}">사업자번호</label><br>
            <input name="radio" id="forSales" type="radio" th:checked="${form.license!=null?'checked':''}"
                   onchange="setDisplay()">
            <label for="forSales" th:text="#{label.member.business}">사업자</label>
            <input name="radio" id="forNormal" style="margin-left: 20px;"
                   th:checked="${form.license==null?'checked':''}" type="radio" onchange="setDisplay()">
            <label for="forNormal" th:text="#{label.member.normal}">개인</label>
            <input type="text" id="license" th:field="*{license}" class="form-control"
                   th:errorclass="field-error">
            <div class="field-error" th:errors="*{license}"/>
        </div>

        <hr class="my-4">
        <div class="row">
            <div class="col">
                <button class="w-100 btn btn-primary btn-lg" type="submit" th:text="#{button.change}">수정</button>
            </div>
            <div class="col">
                <button class="w-100 btn btn-secondary btn-lg"
                        onclick="location.href='../home.html'"
                        th:onclick="|location.href='@{/}'|"
                        th:text="#{button.cancel}"
                        type="button">취소
                </button>
            </div>
        </div>
    </form>
</div> <!-- /container -->

<script>
    function validate() {
        let re = /^[a-zA-Z0-9]{4,20}$/ // 아이디와 패스워드가 적합한지 검사할 정규식
        let emailRe = /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*.[a-zA-Z]{2,3}$/i;
        let nameRe = /^[가-힣a-zA-Z]{2,20}$/;
        let phoneRe = /^010\d{8}$/;

        let ageRe = /^[0-9]{1,3}$/;
        // 이메일이 적합한지 검사할 정규식

        // let id = document.getElementById("id");
        let pw = document.getElementById("password");
        let name = document.getElementById("name");
        let age = document.getElementById("age");
        let phone = document.getElementById("phone");
        let email = document.getElementById("email");

        // ------------ 이메일 까지 -----------

        if (!check(re, id, "아이디는 4~20자의 영문 대소문자와 숫자로만 입력해주세요,")) {
            return false;
        }

        if (!check(re, pw, "비밀번호는 4~20자의 영문 대소문자와 숫자로만 입력해주세요.")) {
            return false;
        }

        if (!check(nameRe, name, "이름은 2~20자의 한글 또는 영문으로 입력해주세요.")) {
            return false;
        }

        if (!check(ageRe, age, "나이는 12~120 범위만 입력해주세요.")) {
            return false;
        }

        if (!check(phoneRe, phone, "전화번호는 010으로 시작하여 10~11자리로 입력해주세요.")) {
            return false;
        }

        // if(email.value=="") {
        //     alert("이메일을 입력해 주세요");
        //     email.focus();
        //     return false;
        // }

        // if(!check(emailRe, email, "적합하지 않은 이메일 형식입니다.")) {
        //     return false;
        // }

        alert("수정이 완료되었습니다.");
    }

    function check(re, what, message) {
        if (re.test(what.value)) {
            return true;
        }
        alert(message);
        // what.value = "";
        what.focus();
    }

    function setDisplay() {
        if ($('input:radio[id=forNormal]').is(':checked')) {
            $('#license').hide();
        } else {
            $('#license').show();
        }
    }

    const validityMessage = {
        badInput: '잘못된 입력입니다.',
        patternMismatch: '패턴에 맞게 입력하세요.',
        rangeOverflow: '범위를 초과하였습니다.',
        rangeUnderflow: '범위에 미달하였습니다.',
        stepMismatch: '간격에 맞게 입력하세요',
        tooLong: '최대 입력 범위를 벗어났습니다.',
        tooShort: '최소 입력 범위를 벗어났습니다.',
        typeMismatch: '형식에 맞게 입력해주세요',
        valueMissing: '빈 값을 입력할 수 없습니다.',
    }

    function getMessage(validity) {
        for (const key in validityMessage) {
            if (validity[key]) {
                return validityMessage[key]
            }
        }
    }

    function showError(input) {
        /**
         * 커스텀 메세지: setCustomValidity()
         * https://developer.mozilla.org/en-US/docs/Web/API/HTMLSelectElement/setCustomValidity
         * - 오류가 있으면 문자열 전달
         * - 오류가 없으면 빈 문자열 전달
         */
        console.log('showError', getMessage(input.validity))
        input.setCustomValidity(getMessage(input.validity) || '')
    }

    function onload() {
        document.querySelectorAll('input').forEach(input => {

            input.addEventListener('invalid', () => {
                document.forms[0].classList.add('was-validated')

                // 커스텀 에러메세지 설정
                showError(input)
            })

            // 인풋시
            input.addEventListener('input', () => {
                if (document.forms[0].classList.contains('was-validated')) {
                    input.reportValidity()
                }
            })
        })
    }

    document.addEventListener('DOMContentLoaded', onload);
    document.addEventListener('DOMContentLoaded', setDisplay);
    document.addEventListener('window.onunload', validate);

</script>

</body>
</html>